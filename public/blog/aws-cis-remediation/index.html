<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>CIS AWS Foundations Benchmark | micro.blog</title>
<meta name="keywords" content="aws, compliance, security" />
<meta name="description" content="Talk aboput making it hard for customers...">
<meta name="author" content="Theodore">
<link rel="canonical" href="http://mb.wedesign.ie/blog/aws-cis-remediation/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css" integrity="sha256-yIlj/i15RiAA/Q&#43;xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js" integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="http://mb.wedesign.ie/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://mb.wedesign.ie/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://mb.wedesign.ie/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://mb.wedesign.ie/apple-touch-icon.png">
<link rel="mask-icon" href="http://mb.wedesign.ie/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="CIS AWS Foundations Benchmark" />
<meta property="og:description" content="Talk aboput making it hard for customers..." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://mb.wedesign.ie/blog/aws-cis-remediation/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2022-03-25T07:13:50&#43;00:00" />
<meta property="article:modified_time" content="2022-03-25T07:13:50&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CIS AWS Foundations Benchmark"/>
<meta name="twitter:description" content="Talk aboput making it hard for customers..."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Blogs",
      "item": "http://mb.wedesign.ie/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "CIS AWS Foundations Benchmark",
      "item": "http://mb.wedesign.ie/blog/aws-cis-remediation/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "CIS AWS Foundations Benchmark",
  "name": "CIS AWS Foundations Benchmark",
  "description": "Talk aboput making it hard for customers...",
  "keywords": [
    "aws", "compliance", "security"
  ],
  "articleBody": "First and foremost, Happy Greek National Day! (It just so happens today is the day)\nThis article emanates directly from a very real need I encountered when trying to manage 9 AWS accounts simulatniously. I wanted to make sure to set some alarms and alerts for each account, in order to somewhat automate the overall account security.\nI reality, the origins of this need are nested in the AWS Security Hub and the CIS AWS Foundations Benchmark standard (but let’s not make us look silly).\nHere is a list of all the controls that the standard requires you to implement. It is easy to see how creating this manually would be a major pain in the back.\nIn come,… CloudFormation. (yes, yes Vali, the day has come where you see me praise CloudFormation).\nThe template below will set the alarms and alerts required to satisfy the CIS AWS Foundations Benchmark.\nDisclamer: I did not create this! If I still had the source, I would definitely slap it here as it deserves credit!\n--- AWSTemplateFormatVersion: '2010-09-09' Description: Automate Section 3 - Monitoring of the CIS AWS Foundations Benchmark controls and send alarms to an email address. Metadata: AWS::CloudFormation::Interface: ParameterGroups: - Label: default: ALARM SNS TOPIC Parameters: - SetEmail - SetALARMTopicName - SetALARMTopicDisplayName - Label: default: CLOUDTRAIL SNS TOPIC Parameters: - SetTRAILTopicName - SetTRAILTopicDisplayName - Label: default: S3 \u0026 CLOUDTRAIL Parameters: - PreExistingS3BucketCloudTrail - CrossAccount01 - CrossAccount02 - CrossAccount03 - CloudTrailLogGroupName - NameCloudTrailRole - Label: default: CLOUDWATCH Parameters: - CloudWatchLogsRetention - Label: default: NAME YOUR METRIC NAMESPACE Parameters: - NameYourNameSpace - Label: default: NAME YOUR ALARMS \u0026 METRIC FILTER NAMES Parameters: - 31UnauthAPICalls - 32MgmtConsoleNoMFA - 33UseOfRootAcct - 34IAMPolicyChanges - 35CloudTrailConfigChanges - 36ConsoleAuthFailures - 37DisableDeleteCMK - 38S3BucketPolicyChanges - 39AWSConfigChanges - 310SecGroupChanges - 311NACLChanges - 312NetworkGatewayChanges - 313RouteTableChanges - 314VPCChanges ParameterLabels: SetEmail: default: Alarm Email SetALARMTopicName: default: (OPTIONAL) Alarm Topic Name SetALARMTopicDisplayName: default: (SEMI-OPTIONAL) Alarm Topic Display Name SetTRAILTopicName: default: (OPTIONAL) Cloudtrail Topic Name SetTRAILTopicDisplayName: default: (SEMI-OPTIONAL) Cloudtrail Topic Display Name CloudWatchLogsRetention: default: CloudWatch Log Retention PreExistingS3BucketCloudTrail: default: CloudTrail S3 Bucket CrossAccount01: default: Cross-Account 01 CrossAccount02: default: Cross-Account 02 CrossAccount03: default: Cross-Account 03 CloudTrailLogGroupName: default: (OPTIONAL) CloudTrail Log Group Name NameCloudTrailRole: default: CloudTrail Role Name NameYourNameSpace: default: Metric Name Space 31UnauthAPICalls: default: Unauthorized API Calls 32MgmtConsoleNoMFA: default: Management Console Sign-in w/o MFA 33UseOfRootAcct: default: Usage of \"root\" Account 34IAMPolicyChanges: default: IAM Policy Changes 35CloudTrailConfigChanges: default: CloudTrail Configuration Changes 37DisableDeleteCMK: default: Disabling / Deletion of CMKs 38S3BucketPolicyChanges: default: S3 Bucket Policy Changes 39AWSConfigChanges: default: AWS Config Changes 310SecGroupChanges: default: Security Group Changes 311NACLChanges: default: NACL Changes 312NetworkGatewayChanges: default: Network Gateway Changes 313RouteTableChanges: default: Route Table Changes 314VPCChanges: default: VPC Changes Parameters: SetEmail: Type: String Default: \"example@example.com\" Description: Triggered alarms will alert to this email address. Verification required and you can opt-out later. Make sure to validate otherwise you won't be able to delete the subscription and have to wait 3 days for automatic deletion. # REGEX Help: # We could get fancy with some serious REGEX action here but keep it simple. # This allows one or more characters (.+) in front and behind the @ symbol. AllowedPattern: \".+@.+\" ConstraintDescription: You must enter one or more characters before and after the @ symbol. SetALARMTopicName: Type: String Default: CIS-BENCHMARK-ALARMS Description: \"Set a unique name for your CloudWatch Alarm SNS Topic. If you don't specify a name, a random name like -AlarmNotificationTopic-9VWR9AVOB5QS will be automatically generated.\" MinLength: '0' MaxLength: '256' AllowedPattern: \"[\\\\w_-]*\" SetALARMTopicDisplayName: Type: String Default: cis-alarm Description: \"REQUIRED for SMS. Can only use up to 10 characters from the AWS console.\" MinLength: '0' MaxLength: '10' AllowedPattern: \"[\\\\w_-]*\" SetTRAILTopicName: Type: String Default: CIS-BENCHMARK-CLOUDTRAIL Description: \"Set a unique name for your CloudTrail SNS Topic. If you don't specify a name, a random name like -TrailTopic-9VWR9AVOB5QS will be automatically generated.\" MinLength: '0' MaxLength: '256' AllowedPattern: \"[\\\\w_-]*\" SetTRAILTopicDisplayName: Type: String Default: cis-cldtrl Description: \"REQUIRED for SMS. Can only use up to 10 characters from the AWS console.\" MinLength: '0' MaxLength: '10' AllowedPattern: \"[\\\\w_-]*\" CloudWatchLogsRetention: Description: The number of days log events are kept in CloudWatch Logs Type: Number Default: 90 AllowedValues: - 1 - 3 - 5 - 7 - 14 - 30 - 60 - 90 - 120 - 150 - 180 - 365 - 400 - 545 - 731 - 1827 - 3653 PreExistingS3BucketCloudTrail: #Description: \"Enter an unique name for your EXISTING CloudTrail S3 bucket that only contains lowercase letters, numbers, periods (.), and dashes (-). If you don't specify a name, a random name like \\\"-cloudtrails3bucket-2wpe5iffv606\\\" will be automatically generated. Note that this bucket's DeletionPolicy is set to Retain. (i.e. Stack deletion will not delete the bucket.)\" Description: \"Enter the name of your EXISTING root S3 bucket for S3 log collection or the export name of the bucket to send logs to. Note that the templates have to be in the same region.\" Type: String # Typically S3 bucket names must be between 3 and 63 characters but since we want to allow an empty string, set MinLength to '0'. # Ref: http://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-s3-bucket-naming-requirements.html MinLength: '0' MaxLength: '63' # REGEX Help: # This allows one or more (+) lower case alphanumeric characters (a-z0-9), no spaces, and the characters '.' (period) and '-' (hyphen) OR an empty string: ^(|)$ AllowedPattern: \"^(|[a-z0-9.-]+)$\" ConstraintDescription: The bucket name must contain only lowercase letters, numbers, periods (.), and dashes (-). CrossAccount01: Description: \"Enter the account name from where you'd like to receive CloudTrail logs. Leave empty if none.\" Type: String AllowedPattern: \"(|\\\\d{12})\" ConstraintDescription: AWS accounts are 12 digits long. Enter 12 digits or leave blank. CrossAccount02: Description: \"Enter the account name from where you'd like to receive CloudTrail logs. Leave empty if none.\" Type: String AllowedPattern: \"(|\\\\d{12})\" ConstraintDescription: AWS accounts are 12 digits long. Enter 12 digits or leave blank. CrossAccount03: Description: \"Enter the account name from where you'd like to receive CloudTrail logs. Leave empty if none.\" Type: String AllowedPattern: \"(|\\\\d{12})\" ConstraintDescription: AWS accounts are 12 digits long. Enter 12 digits or leave blank. CloudTrailLogGroupName: Description: Enter a name for your CloudTrail LogGroup. Type: String Default: CloudTrail/DefaultLogGroup MinLength: '0' MaxLength: '512' AllowedPattern: \"[\\\\w-/.]+\" ConstraintDescription: Log group names can be between 1 and 512 characters long. Allowed characters include a-z, A-Z, 0-9, '_' (underscore), '-' (hyphen), '/' (forward slash), and '.' (period). NameCloudTrailRole: Description: \"A unique name for a CloudTrail Role to be created that contains alphanumeric characters, no spaces, and the characters: = , . @ -. If you don't specify a name, a random name like \\\"-TrailLogGroupRole-1OFN28AF4AUPV\\\" will be automatically generated.\" Type: String MinLength: '0' MaxLength: '64' # REGEX Help: # This allows one or more (+) alphanumeric characters (\\w) with the symbols =,.@- OR an empty string: ^(|)$ AllowedPattern: \"^(|[|\\\\w=,.@-]+)$\" ConstraintDescription: \"The role name must contain only upper and lowercase alphanumeric characters with no spaces. These characters are alllowed: = , . @ -\" NameYourNameSpace: Description: \"A namespace is a container for CloudWatch metrics. Metrics in different namespaces are isolated from each other, so that metrics from different applications are not mistakenly aggregated into the same statistics. Possible characters are: alphanumeric characters (0-9A-Za-z), period (.), hyphen (-), underscore (_), forward slash (/), hash (#), and colon (:).\" Type: String MaxLength: '256' Default: CIS-3-MONITORING 31UnauthAPICalls: Description: 3.01 Ensure a log metric filter and alarm exist for unauthorized API calls Type: String Default: CIS Benchmark v.1.1 - 3.01 Unauthorized API Calls MinLength: '1' MaxLength: '255' # REGEX Help: # This allows one or more (+) alphanumeric characters (\\w) with the symbols -_/. # Must escape \"\\\" and symbols with \"\\\" AllowedPattern: \"[\\\\w\\\\s-_/.]+\" ConstraintDescription: \"Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./\" 32MgmtConsoleNoMFA: Description: 3.02 Ensure a log metric filter and alarm exist for Management Console sign-in without MFA (Scored) Type: String Default: CIS Benchmark v.1.1 - 3.02 Management Console Sign-in Without MFA MinLength: '1' MaxLength: '255' AllowedPattern: \"[\\\\w\\\\s-_/.]+\" ConstraintDescription: \"Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./\" 33UseOfRootAcct: Description: 3.03 Ensure a log metric filter and alarm exist for usage of \"root\" account (Scored) Type: String # Be careful - can't use quotes in Metric Filter name so \"root\" becomes root. Default: CIS Benchmark v.1.1 - 3.03 Usage of root Account MinLength: '1' MaxLength: '255' AllowedPattern: \"[\\\\w\\\\s-_/.]+\" ConstraintDescription: \"Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./\" 34IAMPolicyChanges: Description: 3.04 Ensure a log metric filter and alarm exist for IAM policy changes (Scored) Type: String Default: CIS Benchmark v.1.1 - 3.04 IAM Policy Changes MinLength: '1' MaxLength: '255' AllowedPattern: \"[\\\\w\\\\s-_/.]+\" ConstraintDescription: \"Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./\" 35CloudTrailConfigChanges: Description: 3.05 Ensure a log metric filter and alarm exist for CloudTrail configuration changes (Scored) Type: String Default: CIS Benchmark v.1.1 - 3.05 CloudTrail Config Changes MinLength: '1' MaxLength: '255' AllowedPattern: \"[\\\\w\\\\s-_/.]+\" ConstraintDescription: \"Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./\" 36ConsoleAuthFailures: Description: 3.06 Ensure a log metric filter and alarm exist for AWS Management Console authentication failures (Scored) Type: String Default: CIS Benchmark v.1.1 - 3.06 AWS Management Console Authentication Failures MinLength: '1' MaxLength: '255' AllowedPattern: \"[\\\\w\\\\s-_/.]+\" ConstraintDescription: \"Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./\" 37DisableDeleteCMK: Description: 3.07 Ensure a log metric filter and alarm exist for disabling or scheduled deletion of customer created CMKs (Scored) Type: String Default: CIS Benchmark v.1.1 - 3.07 Disabling or Scheduled Deletion of Customer Created CMKs MinLength: '1' MaxLength: '255' AllowedPattern: \"[\\\\w\\\\s-_/.]+\" ConstraintDescription: \"Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./\" 38S3BucketPolicyChanges: Description: 3.08 Ensure a log metric filter and alarm exist for S3 bucket policy changes (Scored) Type: String Default: CIS Benchmark v.1.1 - 3.08 S3 Bucket Policy Changes MinLength: '1' MaxLength: '255' AllowedPattern: \"[\\\\w\\\\s-_/.]+\" ConstraintDescription: \"Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./\" 39AWSConfigChanges: Description: 3.09 Ensure a log metric filter and alarm exist for AWS Config configuration changes (Scored) Type: String Default: CIS Benchmark v.1.1 - 3.09 AWS Config Configuration Changes MinLength: '1' MaxLength: '255' AllowedPattern: \"[\\\\w\\\\s-_/.]+\" ConstraintDescription: \"Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./\" 310SecGroupChanges: Description: 3.10 Ensure a log metric filter and alarm exist for AWS Config configuration changes (Scored) Type: String Default: CIS Benchmark v.1.1 - 3.10 Security Group Changes MinLength: '1' MaxLength: '255' AllowedPattern: \"[\\\\w\\\\s-_/.]+\" ConstraintDescription: \"Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./\" 311NACLChanges: Description: 3.11 Ensure a log metric filter and alarm exist for changes to Network Access Control Lists (NACL) (Scored) Type: String # Be careful - \"()\" not allowed so (NACL) becomes NACL. Default: CIS Benchmark v.1.1 - 3.11 Changes to Network Access Control Lists NACL MinLength: '1' MaxLength: '255' AllowedPattern: \"[\\\\w\\\\s-_/.]+\" ConstraintDescription: \"Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./\" 312NetworkGatewayChanges: Description: 3.12 Ensure a log metric filter and alarm exist for changes to network gateways (Scored) Type: String Default: CIS Benchmark v.1.1 - 3.12 Changes to Network Gateways MinLength: '1' MaxLength: '255' AllowedPattern: \"[\\\\w\\\\s-_/.]+\" ConstraintDescription: \"Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./\" 313RouteTableChanges: Description: 3.13 Ensure a log metric filter and alarm exist for route table changes (Scored) Type: String Default: CIS Benchmark v.1.1 - 3.13 Route Table Changes MinLength: '1' MaxLength: '255' AllowedPattern: \"[\\\\w\\\\s-_/.]+\" ConstraintDescription: \"Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./\" 314VPCChanges: Description: 3.14 Ensure a log metric filter and alarm exist for VPC changes (Scored) Type: String Default: CIS Benchmark v.1.1 - 3.14 VPC Changes MinLength: '1' MaxLength: '255' AllowedPattern: \"[\\\\w\\\\s-_/.]+\" ConstraintDescription: \"Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./\" Conditions: # Set these little monkeys to FALSE if no input from the user. NeedCloudTrailS3Bucket: !Equals [!Ref PreExistingS3BucketCloudTrail, \"\"] NeedCrossAccount01: !Equals [!Ref CrossAccount01, \"\"] NeedCrossAccount02: !Equals [!Ref CrossAccount02, \"\"] NeedCrossAccount03: !Equals [!Ref CrossAccount03, \"\"] WantALARMTopicName: !Equals [!Ref SetALARMTopicName, \"\"] NeedTRAILTopicName: !Equals [!Ref SetTRAILTopicName, \"\"] WantCloudTrailRoleName: !Equals [!Ref NameCloudTrailRole, \"\"] Resources: CloudTrailS3Bucket: Condition: NeedCloudTrailS3Bucket DeletionPolicy: Retain Type: AWS::S3::Bucket Properties: # BucketName not required but auto-generated one looks sloppy. # Reference: http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-s3-bucket.html#cfn-s3-bucket-name BucketName: !If [NeedCloudTrailS3Bucket, !Ref \"AWS::NoValue\", !Ref PreExistingS3BucketCloudTrail] CloudTrailS3BucketPolicy: #Condition: NeedCloudTrailS3Bucket Type: AWS::S3::BucketPolicy Properties: Bucket: !If [NeedCloudTrailS3Bucket, !Ref CloudTrailS3Bucket, !Ref PreExistingS3BucketCloudTrail] PolicyDocument: Version: '2012-10-17' Statement: - Sid: AWSCloudTrailAclCheck Effect: Allow Principal: Service: cloudtrail.amazonaws.com Action: s3:GetBucketAcl Resource: Fn::Join: - '' - - 'arn:aws:s3:::' - !If [NeedCloudTrailS3Bucket, !Ref CloudTrailS3Bucket, !Ref PreExistingS3BucketCloudTrail] - Sid: AWSCloudTrailWriteAdminS3 Effect: Allow Principal: Service: cloudtrail.amazonaws.com Action: s3:PutObject Resource: - Fn::Join: - '' - - 'arn:aws:s3:::' - !If [NeedCloudTrailS3Bucket, !Ref CloudTrailS3Bucket, !Ref PreExistingS3BucketCloudTrail] - \"/AWSLogs/\" - Ref: AWS::AccountId - \"/*\" - Fn::Join: - '' - - 'arn:aws:s3:::' - !If [NeedCloudTrailS3Bucket, !Ref CloudTrailS3Bucket, !Ref PreExistingS3BucketCloudTrail] - \"/AWSLogs/\" # Not sure if this is the best way, but use default account if not CrossAccount specified. - !If [NeedCrossAccount01, !Ref \"AWS::AccountId\", !Ref CrossAccount01] - \"/*\" - Fn::Join: - '' - - 'arn:aws:s3:::' - !If [NeedCloudTrailS3Bucket, !Ref CloudTrailS3Bucket, !Ref PreExistingS3BucketCloudTrail] - \"/AWSLogs/\" - !If [NeedCrossAccount02, !Ref \"AWS::AccountId\", !Ref CrossAccount02] - \"/*\" - Fn::Join: - '' - - 'arn:aws:s3:::' - !If [NeedCloudTrailS3Bucket, !Ref CloudTrailS3Bucket, !Ref PreExistingS3BucketCloudTrail] - \"/AWSLogs/\" - !If [NeedCrossAccount03, !Ref \"AWS::AccountId\", !Ref CrossAccount03] - \"/*\" Condition: StringEquals: s3:x-amz-acl: bucket-owner-full-control TrailLogGroup: Type: AWS::Logs::LogGroup Properties: LogGroupName: Ref: CloudTrailLogGroupName RetentionInDays: Ref: CloudWatchLogsRetention TrailLogGroupRole: Type: AWS::IAM::Role Properties: # RoleName not required but looks sloppy if not set. # If the user didn't input a name (i.e. FALSE condition), \"AWS::NoValue\" removes the RoleName property and a random name for the IAM role will be created. RoleName: !If [WantCloudTrailRoleName, !Ref \"AWS::NoValue\", !Ref NameCloudTrailRole] AssumeRolePolicyDocument: Version: '2012-10-17' Statement: - Sid: AssumeRole1 Effect: Allow Principal: Service: cloudtrail.amazonaws.com Action: sts:AssumeRole Policies: - PolicyName: cloudtrail-policy PolicyDocument: Version: '2012-10-17' Statement: - Sid: AWSCloudTrailCreateLogStream2014110 Effect: Allow Action: - logs:CreateLogStream Resource: - Fn::GetAtt: - TrailLogGroup - Arn - Sid: AWSCloudTrailPutLogEvents20141101 Effect: Allow Action: - logs:PutLogEvents Resource: - Fn::GetAtt: - TrailLogGroup - Arn TrailTopic: Type: AWS::SNS::Topic Properties: DisplayName: Ref: SetTRAILTopicDisplayName TopicName: !If [NeedTRAILTopicName, !Ref \"AWS::NoValue\", !Ref SetTRAILTopicName] TrailTopicPolicy: DependsOn: - TrailTopic Type: AWS::SNS::TopicPolicy Properties: PolicyDocument: Version: '2008-10-17' Statement: - Sid: AWSCloudTrailSNSPolicy Effect: Allow Principal: Service: cloudtrail.amazonaws.com Resource: Ref: TrailTopic Action: sns:Publish Topics: - Ref: TrailTopic Trail: DependsOn: - CloudTrailS3BucketPolicy - TrailTopicPolicy Type: AWS::CloudTrail::Trail Properties: IncludeGlobalServiceEvents: true IsLogging: true IsMultiRegionTrail: true # If the user didn't input a name (i.e. FALSE condition), use the auto-generated bucket name created in resource name CloudTrailS3Bucket. Cannot use \"AWS::NoValue\" because property S3BucketName is required. Ref: http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudtrail-trail.html#cfn-cloudtrail-trail-s3bucketname S3BucketName: !If [NeedCloudTrailS3Bucket, !Ref CloudTrailS3Bucket, !Ref PreExistingS3BucketCloudTrail] CloudWatchLogsLogGroupArn: Fn::GetAtt: - TrailLogGroup - Arn CloudWatchLogsRoleArn: Fn::GetAtt: - TrailLogGroupRole - Arn SnsTopicName: Fn::GetAtt: - TrailTopic - TopicName EmailAlarmNotificationTopic: Type: AWS::SNS::Topic Properties: DisplayName: Ref: SetALARMTopicDisplayName TopicName: !If [WantALARMTopicName, !Ref \"AWS::NoValue\", !Ref SetALARMTopicName] Subscription: # Reference for the different type of endpoints available: http://docs.aws.amazon.com/sns/latest/api/API_Subscribe.html - Endpoint: !Ref SetEmail Protocol: email # This section configures Metric Filters and associated Alarms. # Note that Metric Filter names cannot be set from CloudFormation. # Ref: http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-logs-metricfilter.html # Metric Filter Names will display as --# Eg. cis-controls-3-monitoring-31UnAuthAPICallsMetricFilter-1GNOXICLU4ZZD 31UnAuthAPICallsMetricFilter: DependsOn: - TrailLogGroup Type: AWS::Logs::MetricFilter Properties: LogGroupName: Ref: CloudTrailLogGroupName FilterPattern: \"{ ($.errorCode = \\\"*UnauthorizedOperation\\\") || ($.errorCode = \\\"AccessDenied*\\\" ) }\" MetricTransformations: - MetricName: !Ref 31UnauthAPICalls MetricNamespace: !Ref NameYourNameSpace MetricValue: '1' 31UnAuthAPICallsAlarm: Type: AWS::CloudWatch::Alarm Properties: AlarmName: !Ref 31UnauthAPICalls AlarmDescription: Alarm for Unauthorized API Calls. AlarmActions: - Ref: EmailAlarmNotificationTopic MetricName: !Ref 31UnauthAPICalls Namespace: !Ref NameYourNameSpace ComparisonOperator: GreaterThanOrEqualToThreshold EvaluationPeriods: '1' Period: '300' Statistic: Sum Threshold: '1' 32MgmtConsoleNoMFAMetricFilter: DependsOn: - TrailLogGroup Type: AWS::Logs::MetricFilter Properties: LogGroupName: Ref: CloudTrailLogGroupName FilterPattern: \"{ ($.additionalEventData.MFAUsed = \\\"No\\\") \u0026\u0026 ($.eventName = \\\"ConsoleLogin\\\") }\" MetricTransformations: - MetricName: !Ref 32MgmtConsoleNoMFA MetricNamespace: !Ref NameYourNameSpace MetricValue: '1' 32MgmtConsoleNoMFAAlarm: Type: AWS::CloudWatch::Alarm Properties: AlarmName: !Ref 32MgmtConsoleNoMFA AlarmDescription: Alarm for Management Console Sign-in without MFA . AlarmActions: - Ref: EmailAlarmNotificationTopic MetricName: !Ref 32MgmtConsoleNoMFA Namespace: !Ref NameYourNameSpace ComparisonOperator: GreaterThanOrEqualToThreshold EvaluationPeriods: '1' Period: '300' Statistic: Sum Threshold: '1' 33UseOfRootAcctMetricFilter: DependsOn: - TrailLogGroup Type: AWS::Logs::MetricFilter Properties: LogGroupName: Ref: CloudTrailLogGroupName FilterPattern: \"{ $.userIdentity.type = \\\"Root\\\" \u0026\u0026 $.userIdentity.invokedBy NOT EXISTS \u0026\u0026 $.eventType != \\\"AwsServiceEvent\\\" }\" MetricTransformations: - MetricName: !Ref 33UseOfRootAcct MetricNamespace: !Ref NameYourNameSpace MetricValue: '1' 33UseOfRootAcctAlarm: Type: AWS::CloudWatch::Alarm Properties: AlarmName: !Ref 33UseOfRootAcct AlarmDescription: Alarm for Usage of \"root\" Account. AlarmActions: - Ref: EmailAlarmNotificationTopic MetricName: !Ref 33UseOfRootAcct Namespace: !Ref NameYourNameSpace ComparisonOperator: GreaterThanOrEqualToThreshold EvaluationPeriods: '1' Period: '300' Statistic: Sum Threshold: '1' 34IAMPolicyChangesMetricFilter: DependsOn: - TrailLogGroup Type: AWS::Logs::MetricFilter Properties: LogGroupName: Ref: CloudTrailLogGroupName FilterPattern: \"{ ($.eventName=DeleteGroupPolicy) || ($.eventName=DeleteUserPolicy) || ($.eventName=PutGroupPolicy) || ($.eventName=PutRolePolicy) || ($.eventName=PutUserPolicy) || ($.eventName=CreatePolicy) || ($.eventName=DeletePolicy) || ($.eventName=CreatePolicyVersion) || ($.eventName=DeletePolicyVersion) || ($.eventName=AttachRolePolicy) }\" MetricTransformations: - MetricName: !Ref 34IAMPolicyChanges MetricNamespace: !Ref NameYourNameSpace MetricValue: '1' 34IAMPolicyChangesAlarm: Type: AWS::CloudWatch::Alarm Properties: AlarmName: !Ref 34IAMPolicyChanges AlarmDescription: Alarm for IAM Policy Changes. AlarmActions: - Ref: EmailAlarmNotificationTopic MetricName: !Ref 34IAMPolicyChanges Namespace: !Ref NameYourNameSpace ComparisonOperator: GreaterThanOrEqualToThreshold EvaluationPeriods: '1' Period: '300' Statistic: Sum Threshold: '1' 35CloudTrailConfigChangesMetricFilter: DependsOn: - TrailLogGroup Type: AWS::Logs::MetricFilter Properties: LogGroupName: Ref: CloudTrailLogGroupName FilterPattern: \"{ ($.eventName = CreateTrail) || ($.eventName = UpdateTrail) || ($.eventName = DeleteTrail) || ($.eventName = StartLogging) || ($.eventName = StopLogging) }\" MetricTransformations: - MetricName: !Ref 35CloudTrailConfigChanges MetricNamespace: !Ref NameYourNameSpace MetricValue: '1' 35CloudTrailConfigChangesAlarm: Type: AWS::CloudWatch::Alarm Properties: AlarmName: !Ref 35CloudTrailConfigChanges AlarmDescription: Alarm for CloudTrail Configuration Changes. AlarmActions: - Ref: EmailAlarmNotificationTopic MetricName: !Ref 35CloudTrailConfigChanges Namespace: !Ref NameYourNameSpace ComparisonOperator: GreaterThanOrEqualToThreshold EvaluationPeriods: '1' Period: '300' Statistic: Sum Threshold: '1' 36ConsoleAuthFailuresMetricFilter: DependsOn: - TrailLogGroup Type: AWS::Logs::MetricFilter Properties: LogGroupName: Ref: CloudTrailLogGroupName FilterPattern: '{ ($.eventName = ConsoleLogin) \u0026\u0026 ($.errorMessage = \"Failedauthentication\") }' MetricTransformations: - MetricName: !Ref 36ConsoleAuthFailures MetricNamespace: !Ref NameYourNameSpace MetricValue: '1' 36ConsoleAuthFailuresAlarm: Type: AWS::CloudWatch::Alarm Properties: AlarmName: !Ref 36ConsoleAuthFailures AlarmDescription: Alarm for Failed Console Logins. AlarmActions: - Ref: EmailAlarmNotificationTopic MetricName: !Ref 36ConsoleAuthFailures Namespace: !Ref NameYourNameSpace ComparisonOperator: GreaterThanOrEqualToThreshold EvaluationPeriods: '1' Period: '300' Statistic: Sum Threshold: '10' 37DisableDeleteCMKMetricFilter: DependsOn: - TrailLogGroup Type: AWS::Logs::MetricFilter Properties: LogGroupName: Ref: CloudTrailLogGroupName FilterPattern: \"{ ($.eventSource=kms.amazonaws.com) \u0026\u0026 (($.eventName=DisableKey) || ($.eventName=ScheduleKeyDeletion)) }\" MetricTransformations: - MetricName: !Ref 37DisableDeleteCMK MetricNamespace: !Ref NameYourNameSpace MetricValue: '1' 37DisableDeleteCMKAlarm: Type: AWS::CloudWatch::Alarm Properties: AlarmName: !Ref 37DisableDeleteCMK AlarmDescription: Alarm for Disabling or Scheduled Deletion of Customer Created CMKs. AlarmActions: - Ref: EmailAlarmNotificationTopic MetricName: !Ref 37DisableDeleteCMK Namespace: !Ref NameYourNameSpace ComparisonOperator: GreaterThanOrEqualToThreshold EvaluationPeriods: '1' Period: '300' Statistic: Sum Threshold: '1' 38S3BucketPolicyChangesMetricFilter: DependsOn: - TrailLogGroup Type: AWS::Logs::MetricFilter Properties: LogGroupName: Ref: CloudTrailLogGroupName FilterPattern: \"{ ($.eventSource=s3.amazonaws.com) \u0026\u0026 (($.eventName=PutBucketAcl) || ($.eventName = PutBucketPolicy) || ($.eventName = PutBucketCors) || ($.eventName = PutBucketLifecycle) || ($.eventName = PutBucketReplication) || ($.eventName = DeleteBucketPolicy) || ($.eventName = DeleteBucketCors) || ($.eventName=DeleteBucketLifecycle) || ($.eventName = DeleteBucketReplication)) }\" MetricTransformations: - MetricName: !Ref 38S3BucketPolicyChanges MetricNamespace: !Ref NameYourNameSpace MetricValue: '1' 38S3BucketPolicyChangesAlarm: Type: AWS::CloudWatch::Alarm Properties: AlarmName: !Ref 38S3BucketPolicyChanges AlarmDescription: Alarm for S3 Bucket Policy Changes. AlarmActions: - Ref: EmailAlarmNotificationTopic MetricName: !Ref 38S3BucketPolicyChanges Namespace: !Ref NameYourNameSpace ComparisonOperator: GreaterThanOrEqualToThreshold EvaluationPeriods: '1' Period: '300' Statistic: Sum Threshold: '1' 39AWSConfigChangesMetricFilter: DependsOn: - TrailLogGroup Type: AWS::Logs::MetricFilter Properties: LogGroupName: Ref: CloudTrailLogGroupName FilterPattern: \"{($.eventSource = config.amazonaws.com) \u0026\u0026 (($.eventName=StopConfigurationRecorder)||($.eventName=DeleteDeliveryChannel)||($.eventName=PutDeliveryChannel)||($.eventName=PutConfigurationRecorder))}\" MetricTransformations: - MetricName: !Ref 39AWSConfigChanges MetricNamespace: !Ref NameYourNameSpace MetricValue: '1' 39AWSConfigChangesAlarm: Type: AWS::CloudWatch::Alarm Properties: AlarmName: !Ref 39AWSConfigChanges AlarmDescription: Alarm for AWS Config Configuration Changes. AlarmActions: - Ref: EmailAlarmNotificationTopic MetricName: !Ref 39AWSConfigChanges Namespace: !Ref NameYourNameSpace ComparisonOperator: GreaterThanOrEqualToThreshold EvaluationPeriods: '1' Period: '300' Statistic: Sum Threshold: '1' 310SecGroupChangesMetricFilter: DependsOn: - TrailLogGroup Type: AWS::Logs::MetricFilter Properties: LogGroupName: Ref: CloudTrailLogGroupName FilterPattern: \"{ ($.eventName = AuthorizeSecurityGroupIngress) || ($.eventName = AuthorizeSecurityGroupEgress) || ($.eventName = RevokeSecurityGroupIngress) || ($.eventName = RevokeSecurityGroupEgress) || ($.eventName = CreateSecurityGroup) || ($.eventName = DeleteSecurityGroup)}\" MetricTransformations: - MetricName: !Ref 310SecGroupChanges MetricNamespace: !Ref NameYourNameSpace MetricValue: '1' 310SecGroupChangesAlarm: Type: AWS::CloudWatch::Alarm Properties: AlarmName: !Ref 310SecGroupChanges AlarmDescription: Alarm for Security Group Changes. AlarmActions: - Ref: EmailAlarmNotificationTopic MetricName: !Ref 310SecGroupChanges Namespace: !Ref NameYourNameSpace ComparisonOperator: GreaterThanOrEqualToThreshold EvaluationPeriods: '1' Period: '300' Statistic: Sum Threshold: '1' 311NACLChangesMetricFilter: DependsOn: - TrailLogGroup Type: AWS::Logs::MetricFilter Properties: LogGroupName: Ref: CloudTrailLogGroupName FilterPattern: \"{ ($.eventName = CreateNetworkAcl) || ($.eventName = CreateNetworkAclEntry) || ($.eventName = DeleteNetworkAcl) || ($.eventName = DeleteNetworkAclEntry) || ($.eventName = ReplaceNetworkAclEntry) || ($.eventName = ReplaceNetworkAclAssociation) }\" MetricTransformations: - MetricName: !Ref 311NACLChanges MetricNamespace: !Ref NameYourNameSpace MetricValue: '1' 311NACLChangesAlarm: Type: AWS::CloudWatch::Alarm Properties: AlarmName: !Ref 311NACLChanges AlarmDescription: Alarm for Changes to Network Access Control Lists (NACL). AlarmActions: - Ref: EmailAlarmNotificationTopic MetricName: !Ref 311NACLChanges Namespace: !Ref NameYourNameSpace ComparisonOperator: GreaterThanOrEqualToThreshold EvaluationPeriods: '1' Period: '300' Statistic: Sum Threshold: '1' 312NetworkGatewayChangesMetricFilter: DependsOn: - TrailLogGroup Type: AWS::Logs::MetricFilter Properties: LogGroupName: Ref: CloudTrailLogGroupName FilterPattern: \"{ ($.eventName = CreateCustomerGateway) || ($.eventName = DeleteCustomerGateway) || ($.eventName = AttachInternetGateway) || ($.eventName = CreateInternetGateway) || ($.eventName = DeleteInternetGateway) || ($.eventName = DetachInternetGateway) }\" MetricTransformations: - MetricName: !Ref 312NetworkGatewayChanges MetricNamespace: !Ref NameYourNameSpace MetricValue: '1' 312NetworkGatewayChangesAlarm: Type: AWS::CloudWatch::Alarm Properties: AlarmName: !Ref 312NetworkGatewayChanges AlarmDescription: Alarm for Changes to Network Gateways. AlarmActions: - Ref: EmailAlarmNotificationTopic MetricName: !Ref 312NetworkGatewayChanges Namespace: !Ref NameYourNameSpace ComparisonOperator: GreaterThanOrEqualToThreshold EvaluationPeriods: '1' Period: '300' Statistic: Sum Threshold: '1' 313RouteTableChangesMetricFilter: DependsOn: - TrailLogGroup Type: AWS::Logs::MetricFilter Properties: LogGroupName: Ref: CloudTrailLogGroupName FilterPattern: \"{ ($.eventName = CreateRoute) || ($.eventName = CreateRouteTable) || ($.eventName = ReplaceRoute) || ($.eventName = ReplaceRouteTableAssociation) || ($.eventName = DeleteRouteTable) || ($.eventName = DeleteRoute) || ($.eventName = DisassociateRouteTable) }\" MetricTransformations: - MetricName: !Ref 313RouteTableChanges MetricNamespace: !Ref NameYourNameSpace MetricValue: '1' 313RouteTableChangesAlarm: Type: AWS::CloudWatch::Alarm Properties: AlarmName: !Ref 313RouteTableChanges AlarmDescription: Alarm for Route Table Changes. AlarmActions: - Ref: EmailAlarmNotificationTopic MetricName: !Ref 313RouteTableChanges Namespace: !Ref NameYourNameSpace ComparisonOperator: GreaterThanOrEqualToThreshold EvaluationPeriods: '1' Period: '300' Statistic: Sum Threshold: '1' 314VPCChangesMetricFilter: DependsOn: - TrailLogGroup Type: AWS::Logs::MetricFilter Properties: LogGroupName: Ref: CloudTrailLogGroupName FilterPattern: \"{ ($.eventName = CreateVpc) || ($.eventName = DeleteVpc) || ($.eventName = ModifyVpcAttribute) || ($.eventName = AcceptVpcPeeringConnection) || ($.eventName = CreateVpcPeeringConnection) || ($.eventName = DeleteVpcPeeringConnection) || ($.eventName = RejectVpcPeeringConnection) || ($.eventName = AttachClassicLinkVpc) || ($.eventName = DetachClassicLinkVpc) || ($.eventName = DisableVpcClassicLink) || ($.eventName = EnableVpcClassicLink) }\" MetricTransformations: - MetricName: !Ref 314VPCChanges MetricNamespace: !Ref NameYourNameSpace MetricValue: '1' 314VPCChangesChangesAlarm: Type: AWS::CloudWatch::Alarm Properties: AlarmName: !Ref 314VPCChanges AlarmDescription: Alarm for VPC Changes. AlarmActions: - Ref: EmailAlarmNotificationTopic MetricName: !Ref 314VPCChanges Namespace: !Ref NameYourNameSpace ComparisonOperator: GreaterThanOrEqualToThreshold EvaluationPeriods: '1' Period: '300' Statistic: Sum Threshold: '1' Outputs: CloudTrailS3BucketName: Description: CloudTrail S3 Target Bucket Name Value: !If [NeedCloudTrailS3Bucket, !Ref CloudTrailS3Bucket, !Ref PreExistingS3BucketCloudTrail] Export: Name: !Sub \"${AWS::StackName}-BucketName\" NotificationEmail: Description: Email for Alarms Value: !Ref SetEmail TrailLogGroupRole: Description: IAM Role Name for CloudTrail Logs Value: !GetAtt TrailLogGroupRole.Arn ",
  "wordCount" : "3581",
  "inLanguage": "en",
  "datePublished": "2022-03-25T07:13:50Z",
  "dateModified": "2022-03-25T07:13:50Z",
  "author":{
    "@type": "Person",
    "name": "Theodore"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://mb.wedesign.ie/blog/aws-cis-remediation/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "micro.blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://mb.wedesign.ie/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://mb.wedesign.ie" accesskey="h" title="micro.blog (Alt + H)">micro.blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="http://mb.wedesign.ie/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://mb.wedesign.ie/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      CIS AWS Foundations Benchmark
    </h1>
    <div class="post-description">
      Talk aboput making it hard for customers...
    </div>
    <div class="post-meta"><span title='2022-03-25 07:13:50 +0000 UTC'>25 March 2022</span>&nbsp;·&nbsp;Theodore

</div>
  </header> 
  <div class="post-content"><p>First and foremost, Happy Greek National Day!
(It just so happens today is the day)</p>
<p>This article emanates directly from a very real need I encountered when trying to manage 9 AWS accounts simulatniously. I wanted to make sure to set some alarms and alerts for each account, in order to somewhat automate the overall account security.</p>
<p>I reality, the origins of this need are nested in the AWS Security Hub and the <code>CIS AWS Foundations Benchmark standard</code> (but let&rsquo;s not make us look silly).</p>
<p><a href="https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html">Here</a> is a list of all the controls that the standard requires you to implement. It is easy to see how creating this manually would be a <strong>major</strong> pain in the back.</p>
<p>In come,&hellip; CloudFormation. (yes, yes Vali, the day has come where you see me praise CloudFormation).</p>
<p>The template below will set the alarms and alerts required to satisfy the CIS AWS Foundations Benchmark.</p>
<p>Disclamer: I did not create this! If I still had the source, I would definitely slap it here as it deserves credit!</p>
<pre tabindex="0"><code>---
AWSTemplateFormatVersion: &#39;2010-09-09&#39;
Description: Automate Section 3 - Monitoring of the CIS AWS Foundations Benchmark controls and send alarms to an email address.
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: ALARM SNS TOPIC
      Parameters:
      - SetEmail
      - SetALARMTopicName
      - SetALARMTopicDisplayName
    - Label:
        default: CLOUDTRAIL SNS TOPIC
      Parameters:
      - SetTRAILTopicName
      - SetTRAILTopicDisplayName
    - Label:
        default: S3 &amp; CLOUDTRAIL
      Parameters:
      - PreExistingS3BucketCloudTrail
      - CrossAccount01
      - CrossAccount02
      - CrossAccount03
      - CloudTrailLogGroupName
      - NameCloudTrailRole
    - Label:
        default: CLOUDWATCH
      Parameters:
      - CloudWatchLogsRetention
    - Label:
        default: NAME YOUR METRIC NAMESPACE 
      Parameters:  
      - NameYourNameSpace
    - Label:
        default: NAME YOUR ALARMS &amp; METRIC FILTER NAMES
      Parameters:
      - 31UnauthAPICalls
      - 32MgmtConsoleNoMFA
      - 33UseOfRootAcct
      - 34IAMPolicyChanges
      - 35CloudTrailConfigChanges
      - 36ConsoleAuthFailures
      - 37DisableDeleteCMK
      - 38S3BucketPolicyChanges
      - 39AWSConfigChanges
      - 310SecGroupChanges
      - 311NACLChanges
      - 312NetworkGatewayChanges
      - 313RouteTableChanges
      - 314VPCChanges
    ParameterLabels:
      SetEmail:
        default: Alarm Email
      SetALARMTopicName:
        default: (OPTIONAL) Alarm Topic Name
      SetALARMTopicDisplayName:
        default: (SEMI-OPTIONAL) Alarm Topic Display Name
      SetTRAILTopicName:
        default: (OPTIONAL) Cloudtrail Topic Name
      SetTRAILTopicDisplayName:
        default: (SEMI-OPTIONAL) Cloudtrail Topic Display Name
      CloudWatchLogsRetention:
        default: CloudWatch Log Retention
      PreExistingS3BucketCloudTrail:
        default: CloudTrail S3 Bucket
      CrossAccount01:
        default: Cross-Account 01
      CrossAccount02:
        default: Cross-Account 02
      CrossAccount03:
        default: Cross-Account 03
      CloudTrailLogGroupName:
        default: (OPTIONAL) CloudTrail Log Group Name
      NameCloudTrailRole:
        default: CloudTrail Role Name
      NameYourNameSpace:
        default: Metric Name Space
      31UnauthAPICalls:
        default: Unauthorized API Calls
      32MgmtConsoleNoMFA:
        default: Management Console Sign-in w/o MFA
      33UseOfRootAcct:
        default: Usage of &#34;root&#34; Account
      34IAMPolicyChanges:
        default: IAM Policy Changes
      35CloudTrailConfigChanges:
        default: CloudTrail Configuration Changes
      37DisableDeleteCMK:
        default: Disabling / Deletion of CMKs
      38S3BucketPolicyChanges:
        default: S3 Bucket Policy Changes
      39AWSConfigChanges:
        default: AWS Config Changes
      310SecGroupChanges:
        default: Security Group Changes
      311NACLChanges:
        default: NACL Changes
      312NetworkGatewayChanges:
        default: Network Gateway Changes
      313RouteTableChanges:
        default: Route Table Changes
      314VPCChanges:
        default: VPC Changes

Parameters:
  
  SetEmail:
    Type: String
    Default: &#34;example@example.com&#34;
    Description: Triggered alarms will alert to this email address. Verification required and you can opt-out later. Make sure to validate otherwise you won&#39;t be able to delete the subscription and have to wait 3 days for automatic deletion.
    # REGEX Help:
    # We could get fancy with some serious REGEX action here but keep it simple.
    # This allows one or more characters (.+) in front and behind the @ symbol.
    AllowedPattern: &#34;.+@.+&#34;
    ConstraintDescription: You must enter one or more characters before and after the @ symbol. 
  
  SetALARMTopicName:
    Type: String
    Default: CIS-BENCHMARK-ALARMS
    Description: &#34;Set a unique name for your CloudWatch Alarm SNS Topic. If you don&#39;t specify a name, a random name like &lt;stack name&gt;-AlarmNotificationTopic-9VWR9AVOB5QS will be automatically generated.&#34;
    MinLength: &#39;0&#39;
    MaxLength: &#39;256&#39;
    AllowedPattern: &#34;[\\w_-]*&#34;
  
  SetALARMTopicDisplayName:
    Type: String
    Default: cis-alarm
    Description: &#34;REQUIRED for SMS. Can only use up to 10 characters from the AWS console.&#34;
    MinLength: &#39;0&#39;
    MaxLength: &#39;10&#39;
    AllowedPattern: &#34;[\\w_-]*&#34;
  
  SetTRAILTopicName:
    Type: String
    Default: CIS-BENCHMARK-CLOUDTRAIL
    Description: &#34;Set a unique name for your CloudTrail SNS Topic. If you don&#39;t specify a name, a random name like &lt;stack name&gt;-TrailTopic-9VWR9AVOB5QS will be automatically generated.&#34;
    MinLength: &#39;0&#39;
    MaxLength: &#39;256&#39;
    AllowedPattern: &#34;[\\w_-]*&#34;
  
  SetTRAILTopicDisplayName:
    Type: String
    Default: cis-cldtrl
    Description: &#34;REQUIRED for SMS. Can only use up to 10 characters from the AWS console.&#34;
    MinLength: &#39;0&#39;
    MaxLength: &#39;10&#39;
    AllowedPattern: &#34;[\\w_-]*&#34;
  
  CloudWatchLogsRetention:
    Description: The number of days log events are kept in CloudWatch Logs
    Type: Number
    Default: 90
    AllowedValues:
    - 1
    - 3
    - 5
    - 7
    - 14
    - 30
    - 60
    - 90
    - 120
    - 150
    - 180
    - 365
    - 400
    - 545
    - 731
    - 1827
    - 3653
  
  PreExistingS3BucketCloudTrail:
    #Description: &#34;Enter an unique name for your EXISTING CloudTrail S3 bucket that only contains lowercase letters, numbers, periods (.), and dashes (-). If you don&#39;t specify a name, a random name like \&#34;&lt;stack name&gt;-cloudtrails3bucket-2wpe5iffv606\&#34; will be automatically generated. Note that this bucket&#39;s DeletionPolicy is set to Retain. (i.e. Stack deletion will not delete the bucket.)&#34;
    Description: &#34;Enter the name of your EXISTING root S3 bucket for S3 log collection or the export name of the bucket to send logs to. Note that the templates have to be in the same region.&#34;
    Type: String
    # Typically S3 bucket names must be between 3 and 63 characters but since we want to allow an empty string, set MinLength to &#39;0&#39;.
    # Ref: http://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-s3-bucket-naming-requirements.html
    MinLength: &#39;0&#39;
    MaxLength: &#39;63&#39;
    # REGEX Help:
    # This allows one or more (+) lower case alphanumeric characters (a-z0-9), no spaces, and the characters &#39;.&#39; (period) and &#39;-&#39; (hyphen) OR an empty string: ^(|)$
    AllowedPattern: &#34;^(|[a-z0-9.-]+)$&#34;
    ConstraintDescription: The bucket name must contain only lowercase letters, numbers, periods (.), and dashes (-).
  
  CrossAccount01:
    Description: &#34;Enter the account name from where you&#39;d like to receive CloudTrail logs. Leave empty if none.&#34;
    Type: String
    AllowedPattern: &#34;(|\\d{12})&#34;
    ConstraintDescription: AWS accounts are 12 digits long. Enter 12 digits or leave blank.

  CrossAccount02:
    Description: &#34;Enter the account name from where you&#39;d like to receive CloudTrail logs. Leave empty if none.&#34;
    Type: String
    AllowedPattern: &#34;(|\\d{12})&#34;
    ConstraintDescription: AWS accounts are 12 digits long. Enter 12 digits or leave blank.

  CrossAccount03:
    Description: &#34;Enter the account name from where you&#39;d like to receive CloudTrail logs. Leave empty if none.&#34;
    Type: String
    AllowedPattern: &#34;(|\\d{12})&#34;
    ConstraintDescription: AWS accounts are 12 digits long. Enter 12 digits or leave blank.

  CloudTrailLogGroupName:
    Description: Enter a name for your CloudTrail LogGroup.
    Type: String
    Default: CloudTrail/DefaultLogGroup
    MinLength: &#39;0&#39;
    MaxLength: &#39;512&#39;
    AllowedPattern: &#34;[\\w-/.]+&#34;
    ConstraintDescription: Log group names can be between 1 and 512 characters long.
      Allowed characters include a-z, A-Z, 0-9, &#39;_&#39; (underscore), &#39;-&#39; (hyphen), &#39;/&#39;
      (forward slash), and &#39;.&#39; (period).
  
  NameCloudTrailRole:
    Description: &#34;A unique name for a CloudTrail Role to be created that contains alphanumeric characters, no spaces, and the characters: = , . @ -. If you don&#39;t specify a name, a random name like \&#34;&lt;stack name&gt;-TrailLogGroupRole-1OFN28AF4AUPV\&#34; will be automatically generated.&#34;
    Type: String
    MinLength: &#39;0&#39;
    MaxLength: &#39;64&#39;
    # REGEX Help:
    # This allows one or more (+) alphanumeric characters (\w) with the symbols =,.@- OR an empty string: ^(|)$
    AllowedPattern: &#34;^(|[|\\w=,.@-]+)$&#34;
    ConstraintDescription: &#34;The role name must contain only upper and lowercase alphanumeric characters with no spaces. These characters are alllowed: = , . @ -&#34;
  
  NameYourNameSpace:
    Description: &#34;A namespace is a container for CloudWatch metrics. Metrics in different namespaces are isolated from each other, so that metrics from different applications are not mistakenly aggregated into the same statistics. Possible characters are: alphanumeric characters (0-9A-Za-z), period (.), hyphen (-), underscore (_), forward slash (/), hash (#), and colon (:).&#34;
    Type: String
    MaxLength: &#39;256&#39;
    Default: CIS-3-MONITORING
  
  31UnauthAPICalls:
    Description: 3.01 Ensure a log metric filter and alarm exist for unauthorized API calls 
    Type: String
    Default: CIS Benchmark v.1.1 - 3.01 Unauthorized API Calls
    MinLength: &#39;1&#39;
    MaxLength: &#39;255&#39;
    # REGEX Help:
    # This allows one or more (+) alphanumeric characters (\w) with the symbols -_/.
    # Must escape &#34;\&#34; and symbols with &#34;\&#34;
    AllowedPattern: &#34;[\\w\\s-_/.]+&#34;
    ConstraintDescription: &#34;Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./&#34;
  
  32MgmtConsoleNoMFA:
    Description: 3.02 Ensure a log metric filter and alarm exist for Management Console sign-in without MFA (Scored)
    Type: String
    Default: CIS Benchmark v.1.1 - 3.02 Management Console Sign-in Without MFA
    MinLength: &#39;1&#39;
    MaxLength: &#39;255&#39;
    AllowedPattern: &#34;[\\w\\s-_/.]+&#34;
    ConstraintDescription: &#34;Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./&#34;
  
  33UseOfRootAcct:
    Description: 3.03 Ensure a log metric filter and alarm exist for usage of &#34;root&#34; account (Scored)
    Type: String
    # Be careful - can&#39;t use quotes in Metric Filter name so &#34;root&#34; becomes root.
    Default: CIS Benchmark v.1.1 - 3.03 Usage of root Account
    MinLength: &#39;1&#39;
    MaxLength: &#39;255&#39;
    AllowedPattern: &#34;[\\w\\s-_/.]+&#34;
    ConstraintDescription: &#34;Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./&#34;
  
  34IAMPolicyChanges:
    Description: 3.04 Ensure a log metric filter and alarm exist for IAM policy changes (Scored)
    Type: String
    Default: CIS Benchmark v.1.1 - 3.04 IAM Policy Changes
    MinLength: &#39;1&#39;
    MaxLength: &#39;255&#39;
    AllowedPattern: &#34;[\\w\\s-_/.]+&#34;
    ConstraintDescription: &#34;Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./&#34;
  
  35CloudTrailConfigChanges:
    Description: 3.05 Ensure a log metric filter and alarm exist for CloudTrail configuration changes (Scored)
    Type: String
    Default: CIS Benchmark v.1.1 - 3.05 CloudTrail Config Changes
    MinLength: &#39;1&#39;
    MaxLength: &#39;255&#39;
    AllowedPattern: &#34;[\\w\\s-_/.]+&#34;
    ConstraintDescription: &#34;Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./&#34;
  
  36ConsoleAuthFailures:
    Description: 3.06 Ensure a log metric filter and alarm exist for AWS Management Console authentication failures (Scored)
    Type: String
    Default: CIS Benchmark v.1.1 - 3.06 AWS Management Console Authentication Failures
    MinLength: &#39;1&#39;
    MaxLength: &#39;255&#39;
    AllowedPattern: &#34;[\\w\\s-_/.]+&#34;
    ConstraintDescription: &#34;Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./&#34;
  
  37DisableDeleteCMK:
    Description: 3.07 Ensure a log metric filter and alarm exist for disabling or scheduled deletion of customer created CMKs (Scored)
    Type: String
    Default: CIS Benchmark v.1.1 - 3.07 Disabling or Scheduled Deletion of Customer Created CMKs
    MinLength: &#39;1&#39;
    MaxLength: &#39;255&#39;
    AllowedPattern: &#34;[\\w\\s-_/.]+&#34;
    ConstraintDescription: &#34;Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./&#34;
  
  38S3BucketPolicyChanges:
    Description: 3.08 Ensure a log metric filter and alarm exist for S3 bucket policy changes (Scored)
    Type: String
    Default: CIS Benchmark v.1.1 - 3.08 S3 Bucket Policy Changes
    MinLength: &#39;1&#39;
    MaxLength: &#39;255&#39;
    AllowedPattern: &#34;[\\w\\s-_/.]+&#34;
    ConstraintDescription: &#34;Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./&#34;
  
  39AWSConfigChanges:
    Description: 3.09 Ensure a log metric filter and alarm exist for AWS Config configuration changes (Scored)
    Type: String
    Default: CIS Benchmark v.1.1 - 3.09 AWS Config Configuration Changes
    MinLength: &#39;1&#39;
    MaxLength: &#39;255&#39;
    AllowedPattern: &#34;[\\w\\s-_/.]+&#34;
    ConstraintDescription: &#34;Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./&#34;
  
  310SecGroupChanges:
    Description: 3.10 Ensure a log metric filter and alarm exist for AWS Config configuration changes (Scored)
    Type: String
    Default: CIS Benchmark v.1.1 - 3.10 Security Group Changes
    MinLength: &#39;1&#39;
    MaxLength: &#39;255&#39;
    AllowedPattern: &#34;[\\w\\s-_/.]+&#34;
    ConstraintDescription: &#34;Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./&#34;
  
  311NACLChanges:
    Description: 3.11 Ensure a log metric filter and alarm exist for changes to Network Access Control Lists (NACL) (Scored)
    Type: String
    # Be careful - &#34;()&#34; not allowed so (NACL) becomes NACL.
    Default: CIS Benchmark v.1.1 - 3.11 Changes to Network Access Control Lists NACL
    MinLength: &#39;1&#39;
    MaxLength: &#39;255&#39;
    AllowedPattern: &#34;[\\w\\s-_/.]+&#34;
    ConstraintDescription: &#34;Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./&#34;
  
  312NetworkGatewayChanges:
    Description: 3.12 Ensure a log metric filter and alarm exist for changes to network gateways (Scored)
    Type: String
    Default: CIS Benchmark v.1.1 - 3.12 Changes to Network Gateways
    MinLength: &#39;1&#39;
    MaxLength: &#39;255&#39;
    AllowedPattern: &#34;[\\w\\s-_/.]+&#34;
    ConstraintDescription: &#34;Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./&#34;
  
  313RouteTableChanges:
    Description: 3.13 Ensure a log metric filter and alarm exist for route table changes (Scored)
    Type: String
    Default: CIS Benchmark v.1.1 - 3.13 Route Table Changes
    MinLength: &#39;1&#39;
    MaxLength: &#39;255&#39;
    AllowedPattern: &#34;[\\w\\s-_/.]+&#34;
    ConstraintDescription: &#34;Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./&#34;
  
  314VPCChanges:
    Description: 3.14 Ensure a log metric filter and alarm exist for VPC changes (Scored)
    Type: String
    Default: CIS Benchmark v.1.1 - 3.14 VPC Changes
    MinLength: &#39;1&#39;
    MaxLength: &#39;255&#39;
    AllowedPattern: &#34;[\\w\\s-_/.]+&#34;
    ConstraintDescription: &#34;Metric names can contain up to 255 alphanumeric characters, with the following also allowed: -_./&#34;

Conditions:
  
  # Set these little monkeys to FALSE if no input from the user.
  NeedCloudTrailS3Bucket: !Equals [!Ref PreExistingS3BucketCloudTrail, &#34;&#34;]
  NeedCrossAccount01: !Equals [!Ref CrossAccount01, &#34;&#34;]
  NeedCrossAccount02: !Equals [!Ref CrossAccount02, &#34;&#34;]
  NeedCrossAccount03: !Equals [!Ref CrossAccount03, &#34;&#34;]
  WantALARMTopicName: !Equals [!Ref SetALARMTopicName, &#34;&#34;]
  NeedTRAILTopicName: !Equals [!Ref SetTRAILTopicName, &#34;&#34;]
  WantCloudTrailRoleName: !Equals [!Ref NameCloudTrailRole, &#34;&#34;]

Resources:
  
  CloudTrailS3Bucket:
    Condition: NeedCloudTrailS3Bucket
    DeletionPolicy: Retain
    Type: AWS::S3::Bucket
    Properties:
      # BucketName not required but auto-generated one looks sloppy. 
      # Reference: http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-s3-bucket.html#cfn-s3-bucket-name
      BucketName: !If [NeedCloudTrailS3Bucket, !Ref &#34;AWS::NoValue&#34;, !Ref PreExistingS3BucketCloudTrail]
  
  CloudTrailS3BucketPolicy:
    #Condition: NeedCloudTrailS3Bucket
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !If [NeedCloudTrailS3Bucket, !Ref CloudTrailS3Bucket, !Ref PreExistingS3BucketCloudTrail]
      PolicyDocument:
        Version: &#39;2012-10-17&#39;
        Statement:
        - Sid: AWSCloudTrailAclCheck
          Effect: Allow
          Principal:
            Service: cloudtrail.amazonaws.com
          Action: s3:GetBucketAcl
          Resource:
            Fn::Join:
            - &#39;&#39;
            - - &#39;arn:aws:s3:::&#39;
              - !If [NeedCloudTrailS3Bucket, !Ref CloudTrailS3Bucket, !Ref PreExistingS3BucketCloudTrail]
        - Sid: AWSCloudTrailWriteAdminS3
          Effect: Allow
          Principal:
            Service: cloudtrail.amazonaws.com
          Action: s3:PutObject
          Resource:
            - Fn::Join:
              - &#39;&#39;
              - - &#39;arn:aws:s3:::&#39;
                - !If [NeedCloudTrailS3Bucket, !Ref CloudTrailS3Bucket, !Ref PreExistingS3BucketCloudTrail]
                - &#34;/AWSLogs/&#34;
                - Ref: AWS::AccountId
                - &#34;/*&#34;
            - Fn::Join:
              - &#39;&#39;
              - - &#39;arn:aws:s3:::&#39;
                - !If [NeedCloudTrailS3Bucket, !Ref CloudTrailS3Bucket, !Ref PreExistingS3BucketCloudTrail]
                - &#34;/AWSLogs/&#34;
                # Not sure if this is the best way, but use default account if not CrossAccount specified.
                - !If [NeedCrossAccount01, !Ref &#34;AWS::AccountId&#34;, !Ref CrossAccount01]
                - &#34;/*&#34;
            - Fn::Join:
              - &#39;&#39;
              - - &#39;arn:aws:s3:::&#39;
                - !If [NeedCloudTrailS3Bucket, !Ref CloudTrailS3Bucket, !Ref PreExistingS3BucketCloudTrail]
                - &#34;/AWSLogs/&#34;
                - !If [NeedCrossAccount02, !Ref &#34;AWS::AccountId&#34;, !Ref CrossAccount02]
                - &#34;/*&#34;
            - Fn::Join:
              - &#39;&#39;
              - - &#39;arn:aws:s3:::&#39;
                - !If [NeedCloudTrailS3Bucket, !Ref CloudTrailS3Bucket, !Ref PreExistingS3BucketCloudTrail]
                - &#34;/AWSLogs/&#34;
                - !If [NeedCrossAccount03, !Ref &#34;AWS::AccountId&#34;, !Ref CrossAccount03]
                - &#34;/*&#34;
          Condition:
            StringEquals:
              s3:x-amz-acl: bucket-owner-full-control
  
  TrailLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Ref: CloudTrailLogGroupName
      RetentionInDays:
        Ref: CloudWatchLogsRetention
  
  TrailLogGroupRole:
    Type: AWS::IAM::Role
    Properties:
      # RoleName not required but looks sloppy if not set.
      # If the user didn&#39;t input a name (i.e. FALSE condition), &#34;AWS::NoValue&#34; removes the RoleName property and a random name for the IAM role will be created.
      RoleName: !If [WantCloudTrailRoleName, !Ref &#34;AWS::NoValue&#34;, !Ref NameCloudTrailRole]
      AssumeRolePolicyDocument:
        Version: &#39;2012-10-17&#39;
        Statement:
        - Sid: AssumeRole1
          Effect: Allow
          Principal:
            Service: cloudtrail.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: cloudtrail-policy
        PolicyDocument:
          Version: &#39;2012-10-17&#39;
          Statement:
          - Sid: AWSCloudTrailCreateLogStream2014110
            Effect: Allow
            Action:
            - logs:CreateLogStream
            Resource:
            - Fn::GetAtt:
              - TrailLogGroup
              - Arn
          - Sid: AWSCloudTrailPutLogEvents20141101
            Effect: Allow
            Action:
            - logs:PutLogEvents
            Resource:
            - Fn::GetAtt:
              - TrailLogGroup
              - Arn
  
  TrailTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName:
        Ref: SetTRAILTopicDisplayName
      TopicName: !If [NeedTRAILTopicName, !Ref &#34;AWS::NoValue&#34;, !Ref SetTRAILTopicName]
  
  TrailTopicPolicy:
    DependsOn:
    - TrailTopic
    Type: AWS::SNS::TopicPolicy
    Properties:
      PolicyDocument:
        Version: &#39;2008-10-17&#39;
        Statement:
        - Sid: AWSCloudTrailSNSPolicy
          Effect: Allow
          Principal:
            Service: cloudtrail.amazonaws.com
          Resource:
            Ref: TrailTopic
          Action: sns:Publish
      Topics:
      - Ref: TrailTopic
  
  Trail:
    DependsOn:
    - CloudTrailS3BucketPolicy
    - TrailTopicPolicy
    Type: AWS::CloudTrail::Trail
    Properties:
      IncludeGlobalServiceEvents: true
      IsLogging: true
      IsMultiRegionTrail: true
      # If the user didn&#39;t input a name (i.e. FALSE condition), use the auto-generated bucket name created in resource name CloudTrailS3Bucket. Cannot use &#34;AWS::NoValue&#34; because property S3BucketName is required. Ref: http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudtrail-trail.html#cfn-cloudtrail-trail-s3bucketname
      S3BucketName: !If [NeedCloudTrailS3Bucket, !Ref CloudTrailS3Bucket, !Ref PreExistingS3BucketCloudTrail]
      CloudWatchLogsLogGroupArn:
        Fn::GetAtt:
        - TrailLogGroup
        - Arn
      CloudWatchLogsRoleArn:
        Fn::GetAtt:
        - TrailLogGroupRole
        - Arn
      SnsTopicName:
        Fn::GetAtt:
        - TrailTopic
        - TopicName
  
  EmailAlarmNotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName:
        Ref: SetALARMTopicDisplayName
      TopicName: !If [WantALARMTopicName, !Ref &#34;AWS::NoValue&#34;, !Ref SetALARMTopicName]
      Subscription:
      # Reference for the different type of endpoints available: http://docs.aws.amazon.com/sns/latest/api/API_Subscribe.html
      - Endpoint: !Ref SetEmail
        Protocol: email

# This section configures Metric Filters and associated Alarms.
# Note that Metric Filter names cannot be set from CloudFormation.
# Ref: http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-logs-metricfilter.html
# Metric Filter Names will display as &lt;stack name&gt;-&lt;resource ID&gt;-&lt;random number&gt;
# Eg. cis-controls-3-monitoring-31UnAuthAPICallsMetricFilter-1GNOXICLU4ZZD
  31UnAuthAPICallsMetricFilter:
    DependsOn:
    - TrailLogGroup
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName:
        Ref: CloudTrailLogGroupName
      FilterPattern: &#34;{ ($.errorCode = \&#34;*UnauthorizedOperation\&#34;) || ($.errorCode = \&#34;AccessDenied*\&#34; ) }&#34;
      MetricTransformations:
      - MetricName: !Ref 31UnauthAPICalls
        MetricNamespace: !Ref NameYourNameSpace
        MetricValue: &#39;1&#39;
  
  31UnAuthAPICallsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Ref 31UnauthAPICalls
      AlarmDescription: Alarm for Unauthorized API Calls.
      AlarmActions:
      - Ref: EmailAlarmNotificationTopic
      MetricName: !Ref 31UnauthAPICalls
      Namespace: !Ref NameYourNameSpace
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: &#39;1&#39;
      Period: &#39;300&#39;
      Statistic: Sum
      Threshold: &#39;1&#39;
  
  32MgmtConsoleNoMFAMetricFilter:
    DependsOn:
    - TrailLogGroup
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName:
        Ref: CloudTrailLogGroupName
      FilterPattern: &#34;{ ($.additionalEventData.MFAUsed = \&#34;No\&#34;) &amp;&amp; ($.eventName = \&#34;ConsoleLogin\&#34;) }&#34;
      MetricTransformations:
      - MetricName: !Ref 32MgmtConsoleNoMFA
        MetricNamespace: !Ref NameYourNameSpace
        MetricValue: &#39;1&#39;
  
  32MgmtConsoleNoMFAAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Ref 32MgmtConsoleNoMFA
      AlarmDescription: Alarm for Management Console Sign-in without MFA .
      AlarmActions:
      - Ref: EmailAlarmNotificationTopic
      MetricName: !Ref 32MgmtConsoleNoMFA
      Namespace: !Ref NameYourNameSpace
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: &#39;1&#39;
      Period: &#39;300&#39;
      Statistic: Sum
      Threshold: &#39;1&#39;
  
  33UseOfRootAcctMetricFilter:
    DependsOn:
    - TrailLogGroup
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName:
        Ref: CloudTrailLogGroupName
      FilterPattern: &#34;{ $.userIdentity.type = \&#34;Root\&#34; &amp;&amp; $.userIdentity.invokedBy NOT EXISTS &amp;&amp; $.eventType != \&#34;AwsServiceEvent\&#34; }&#34;
      MetricTransformations:
      - MetricName: !Ref 33UseOfRootAcct
        MetricNamespace: !Ref NameYourNameSpace
        MetricValue: &#39;1&#39;
  
  33UseOfRootAcctAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Ref 33UseOfRootAcct
      AlarmDescription: Alarm for Usage of &#34;root&#34; Account.
      AlarmActions:
      - Ref: EmailAlarmNotificationTopic
      MetricName: !Ref 33UseOfRootAcct
      Namespace: !Ref NameYourNameSpace
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: &#39;1&#39;
      Period: &#39;300&#39;
      Statistic: Sum
      Threshold: &#39;1&#39;
  
  34IAMPolicyChangesMetricFilter:
    DependsOn:
    - TrailLogGroup
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName:
        Ref: CloudTrailLogGroupName
      FilterPattern: &#34;{ ($.eventName=DeleteGroupPolicy) || ($.eventName=DeleteUserPolicy)
        || ($.eventName=PutGroupPolicy) || ($.eventName=PutRolePolicy) || ($.eventName=PutUserPolicy)
        || ($.eventName=CreatePolicy) || ($.eventName=DeletePolicy) || ($.eventName=CreatePolicyVersion)
        || ($.eventName=DeletePolicyVersion)  || ($.eventName=AttachRolePolicy) }&#34;
      MetricTransformations:
      - MetricName: !Ref 34IAMPolicyChanges
        MetricNamespace: !Ref NameYourNameSpace
        MetricValue: &#39;1&#39;
  
  34IAMPolicyChangesAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Ref 34IAMPolicyChanges
      AlarmDescription: Alarm for IAM Policy Changes.
      AlarmActions:
      - Ref: EmailAlarmNotificationTopic
      MetricName: !Ref 34IAMPolicyChanges
      Namespace: !Ref NameYourNameSpace
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: &#39;1&#39;
      Period: &#39;300&#39;
      Statistic: Sum
      Threshold: &#39;1&#39;
  
  35CloudTrailConfigChangesMetricFilter:
    DependsOn:
    - TrailLogGroup
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName:
        Ref: CloudTrailLogGroupName
      FilterPattern: &#34;{ ($.eventName = CreateTrail) || ($.eventName = UpdateTrail)
        || ($.eventName = DeleteTrail) || ($.eventName = StartLogging) || ($.eventName
        = StopLogging) }&#34;
      MetricTransformations:
      - MetricName: !Ref 35CloudTrailConfigChanges
        MetricNamespace: !Ref NameYourNameSpace
        MetricValue: &#39;1&#39;
  
  35CloudTrailConfigChangesAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Ref 35CloudTrailConfigChanges
      AlarmDescription: Alarm for CloudTrail Configuration Changes.
      AlarmActions:
      - Ref: EmailAlarmNotificationTopic
      MetricName: !Ref 35CloudTrailConfigChanges
      Namespace: !Ref NameYourNameSpace
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: &#39;1&#39;
      Period: &#39;300&#39;
      Statistic: Sum
      Threshold: &#39;1&#39;
  
  36ConsoleAuthFailuresMetricFilter:
    DependsOn:
    - TrailLogGroup
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName:
        Ref: CloudTrailLogGroupName
      FilterPattern: &#39;{ ($.eventName = ConsoleLogin) &amp;&amp; ($.errorMessage = &#34;Failedauthentication&#34;)
        }&#39;
      MetricTransformations:
      - MetricName: !Ref 36ConsoleAuthFailures
        MetricNamespace: !Ref NameYourNameSpace
        MetricValue: &#39;1&#39;
  
  36ConsoleAuthFailuresAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Ref 36ConsoleAuthFailures
      AlarmDescription: Alarm for Failed Console Logins.
      AlarmActions:
      - Ref: EmailAlarmNotificationTopic
      MetricName: !Ref 36ConsoleAuthFailures
      Namespace: !Ref NameYourNameSpace
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: &#39;1&#39;
      Period: &#39;300&#39;
      Statistic: Sum
      Threshold: &#39;10&#39;
  
  37DisableDeleteCMKMetricFilter:
    DependsOn:
    - TrailLogGroup
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName:
        Ref: CloudTrailLogGroupName
      FilterPattern: &#34;{ ($.eventSource=kms.amazonaws.com) &amp;&amp; (($.eventName=DisableKey)
        || ($.eventName=ScheduleKeyDeletion)) }&#34;
      MetricTransformations:
      - MetricName: !Ref 37DisableDeleteCMK
        MetricNamespace: !Ref NameYourNameSpace
        MetricValue: &#39;1&#39;
  
  37DisableDeleteCMKAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Ref 37DisableDeleteCMK
      AlarmDescription: Alarm for Disabling or Scheduled Deletion of Customer Created CMKs.
      AlarmActions:
      - Ref: EmailAlarmNotificationTopic
      MetricName: !Ref 37DisableDeleteCMK
      Namespace: !Ref NameYourNameSpace
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: &#39;1&#39;
      Period: &#39;300&#39;
      Statistic: Sum
      Threshold: &#39;1&#39;
  
  38S3BucketPolicyChangesMetricFilter:
    DependsOn:
    - TrailLogGroup
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName:
        Ref: CloudTrailLogGroupName
      FilterPattern: &#34;{ ($.eventSource=s3.amazonaws.com) &amp;&amp; (($.eventName=PutBucketAcl)
        || ($.eventName = PutBucketPolicy) || ($.eventName = PutBucketCors) || ($.eventName
        = PutBucketLifecycle) || ($.eventName = PutBucketReplication) || ($.eventName
        = DeleteBucketPolicy) || ($.eventName = DeleteBucketCors) || ($.eventName=DeleteBucketLifecycle)
        || ($.eventName = DeleteBucketReplication)) }&#34;
      MetricTransformations:
      - MetricName: !Ref 38S3BucketPolicyChanges
        MetricNamespace: !Ref NameYourNameSpace
        MetricValue: &#39;1&#39;
  
  38S3BucketPolicyChangesAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Ref 38S3BucketPolicyChanges
      AlarmDescription: Alarm for S3 Bucket Policy Changes.
      AlarmActions:
      - Ref: EmailAlarmNotificationTopic
      MetricName: !Ref 38S3BucketPolicyChanges
      Namespace: !Ref NameYourNameSpace
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: &#39;1&#39;
      Period: &#39;300&#39;
      Statistic: Sum
      Threshold: &#39;1&#39;
  
  39AWSConfigChangesMetricFilter:
    DependsOn:
    - TrailLogGroup
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName:
        Ref: CloudTrailLogGroupName
      FilterPattern: &#34;{($.eventSource = config.amazonaws.com) &amp;&amp; (($.eventName=StopConfigurationRecorder)||($.eventName=DeleteDeliveryChannel)||($.eventName=PutDeliveryChannel)||($.eventName=PutConfigurationRecorder))}&#34;
      MetricTransformations:
      - MetricName: !Ref 39AWSConfigChanges
        MetricNamespace: !Ref NameYourNameSpace
        MetricValue: &#39;1&#39;
  
  39AWSConfigChangesAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Ref 39AWSConfigChanges
      AlarmDescription: Alarm for AWS Config Configuration Changes.
      AlarmActions:
      - Ref: EmailAlarmNotificationTopic
      MetricName: !Ref 39AWSConfigChanges
      Namespace: !Ref NameYourNameSpace
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: &#39;1&#39;
      Period: &#39;300&#39;
      Statistic: Sum
      Threshold: &#39;1&#39;
  
  310SecGroupChangesMetricFilter:
    DependsOn:
    - TrailLogGroup
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName:
        Ref: CloudTrailLogGroupName
      FilterPattern: &#34;{ ($.eventName = AuthorizeSecurityGroupIngress) || ($.eventName
        = AuthorizeSecurityGroupEgress) || ($.eventName = RevokeSecurityGroupIngress)
        || ($.eventName = RevokeSecurityGroupEgress) || ($.eventName = CreateSecurityGroup)
        || ($.eventName = DeleteSecurityGroup)}&#34;
      MetricTransformations:
      - MetricName: !Ref 310SecGroupChanges
        MetricNamespace: !Ref NameYourNameSpace
        MetricValue: &#39;1&#39;
  
  310SecGroupChangesAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Ref 310SecGroupChanges
      AlarmDescription: Alarm for Security Group Changes.
      AlarmActions:
      - Ref: EmailAlarmNotificationTopic
      MetricName: !Ref 310SecGroupChanges
      Namespace: !Ref NameYourNameSpace
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: &#39;1&#39;
      Period: &#39;300&#39;
      Statistic: Sum
      Threshold: &#39;1&#39;
  
  311NACLChangesMetricFilter:
    DependsOn:
    - TrailLogGroup
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName:
        Ref: CloudTrailLogGroupName
      FilterPattern: &#34;{ ($.eventName = CreateNetworkAcl) || ($.eventName = CreateNetworkAclEntry)
        || ($.eventName = DeleteNetworkAcl) || ($.eventName = DeleteNetworkAclEntry)
        || ($.eventName = ReplaceNetworkAclEntry) || ($.eventName = ReplaceNetworkAclAssociation)
        }&#34;
      MetricTransformations:
      - MetricName: !Ref 311NACLChanges
        MetricNamespace: !Ref NameYourNameSpace
        MetricValue: &#39;1&#39;
  
  311NACLChangesAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Ref 311NACLChanges
      AlarmDescription: Alarm for Changes to Network Access Control Lists (NACL).
      AlarmActions:
      - Ref: EmailAlarmNotificationTopic
      MetricName: !Ref 311NACLChanges
      Namespace: !Ref NameYourNameSpace
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: &#39;1&#39;
      Period: &#39;300&#39;
      Statistic: Sum
      Threshold: &#39;1&#39;
  
  312NetworkGatewayChangesMetricFilter:
    DependsOn:
    - TrailLogGroup
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName:
        Ref: CloudTrailLogGroupName
      FilterPattern: &#34;{ ($.eventName = CreateCustomerGateway) || ($.eventName = DeleteCustomerGateway)
        || ($.eventName = AttachInternetGateway) || ($.eventName = CreateInternetGateway)
        || ($.eventName = DeleteInternetGateway) || ($.eventName = DetachInternetGateway)
        }&#34;
      MetricTransformations:
      - MetricName: !Ref 312NetworkGatewayChanges
        MetricNamespace: !Ref NameYourNameSpace
        MetricValue: &#39;1&#39;
  
  312NetworkGatewayChangesAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Ref 312NetworkGatewayChanges
      AlarmDescription: Alarm for Changes to Network Gateways.
      AlarmActions:
      - Ref: EmailAlarmNotificationTopic
      MetricName: !Ref 312NetworkGatewayChanges
      Namespace: !Ref NameYourNameSpace
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: &#39;1&#39;
      Period: &#39;300&#39;
      Statistic: Sum
      Threshold: &#39;1&#39;
  
  313RouteTableChangesMetricFilter:
    DependsOn:
    - TrailLogGroup
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName:
        Ref: CloudTrailLogGroupName
      FilterPattern: &#34;{ ($.eventName = CreateRoute) || ($.eventName = CreateRouteTable)
        || ($.eventName = ReplaceRoute) || ($.eventName = ReplaceRouteTableAssociation)
        || ($.eventName = DeleteRouteTable) || ($.eventName = DeleteRoute) || ($.eventName
        = DisassociateRouteTable) }&#34;
      MetricTransformations:
      - MetricName: !Ref 313RouteTableChanges
        MetricNamespace: !Ref NameYourNameSpace
        MetricValue: &#39;1&#39;
  
  313RouteTableChangesAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Ref 313RouteTableChanges
      AlarmDescription: Alarm for Route Table Changes.
      AlarmActions:
      - Ref: EmailAlarmNotificationTopic
      MetricName: !Ref 313RouteTableChanges
      Namespace: !Ref NameYourNameSpace
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: &#39;1&#39;
      Period: &#39;300&#39;
      Statistic: Sum
      Threshold: &#39;1&#39;
  
  314VPCChangesMetricFilter:
    DependsOn:
    - TrailLogGroup
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName:
        Ref: CloudTrailLogGroupName
      FilterPattern: &#34;{ ($.eventName = CreateVpc) || ($.eventName = DeleteVpc) ||
        ($.eventName = ModifyVpcAttribute) || ($.eventName = AcceptVpcPeeringConnection)
        || ($.eventName = CreateVpcPeeringConnection) || ($.eventName = DeleteVpcPeeringConnection)
        || ($.eventName = RejectVpcPeeringConnection) || ($.eventName = AttachClassicLinkVpc)
        || ($.eventName = DetachClassicLinkVpc) || ($.eventName = DisableVpcClassicLink)
        || ($.eventName = EnableVpcClassicLink) }&#34;
      MetricTransformations:
      - MetricName: !Ref 314VPCChanges
        MetricNamespace: !Ref NameYourNameSpace
        MetricValue: &#39;1&#39;
  
  314VPCChangesChangesAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Ref 314VPCChanges
      AlarmDescription: Alarm for VPC Changes.
      AlarmActions:
      - Ref: EmailAlarmNotificationTopic
      MetricName: !Ref 314VPCChanges
      Namespace: !Ref NameYourNameSpace
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: &#39;1&#39;
      Period: &#39;300&#39;
      Statistic: Sum
      Threshold: &#39;1&#39;

Outputs:
  CloudTrailS3BucketName:
    Description: CloudTrail S3 Target Bucket Name
    Value: !If [NeedCloudTrailS3Bucket, !Ref CloudTrailS3Bucket, !Ref PreExistingS3BucketCloudTrail]
    Export:
      Name: !Sub &#34;${AWS::StackName}-BucketName&#34;
  NotificationEmail:
    Description: Email for Alarms
    Value: !Ref SetEmail
  TrailLogGroupRole:
    Description: IAM Role Name for CloudTrail Logs
    Value: !GetAtt TrailLogGroupRole.Arn
</code></pre>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://mb.wedesign.ie/tags/aws/">aws</a></li>
      <li><a href="http://mb.wedesign.ie/tags/compliance/">compliance</a></li>
      <li><a href="http://mb.wedesign.ie/tags/security/">security</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="http://mb.wedesign.ie/blog/mum-password-manager/">
    <span class="title">Next Page »</span>
    <br>
    <span>Getting my mother on a password manager</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="http://mb.wedesign.ie">micro.blog</a></span>
    <span>
        by
        <a href="https://www.wedesign.ie/" rel="noopener noreferrer" target="_blank">weDesign.ie</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
